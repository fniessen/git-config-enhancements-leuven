#!/usr/bin/env bash

bold=$(tput bold)
reset=$(tput sgr0)

# TODO Return the exit code of the underlying git invocations
# TODO Test with branch that's not yet published (@{u} is not known...)

printf "Searching at most 5 levels of directories...\n"

# Handle directories with spaces in the find command.
while IFS=$'\n' read -r repo_path; do
    printf 'Updating repository %s:\n' "${bold}$repo${reset}"
    if git -C "$repo_path" rev-parse --quiet --verify @{u} >/dev/null 2>&1; then
        if git -C "$repo_path" diff --quiet @{u} &>/dev/null; then
            printf "No changes to push\n"
        else
            printf "Changes found:\n"
            git -C "$repo_path" log --date=short @{u}..
            git -C "$repo_path" push
        fi
    else
        remote_url=$(git -C "$repo_path" config --get remote.origin.url)
        printf >&2 "Error: remote repository '%s' is not accessible or authentication failed\n" "$remote_url"
    fi
    printf "\n"
done < <(find . -maxdepth 5 -name '.git' -type d -print0 | xargs -0 -I {} dirname {} | sed 's#^./##')

## Returns errlvl 0 if $1 is a reachable git remote url
# git-remote-url-reachable() {
#     git ls-remote "$1" CHECK_GIT_REMOTE_URL_REACHABILITY >/dev/null 2>&1
# }
# Usage:
# if git-remote-url-reachable "$url"; then
#     ## code
# fi
