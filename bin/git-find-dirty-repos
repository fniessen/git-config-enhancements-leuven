#!/usr/bin/env bash

# Find dirty Git repositories in the current directory and its subdirectories.

# Options:
#   -v  verbose output

# Preserve the old input field separator.
OLDIFS=$IFS

# Change the input field separator from a space to a null.
IFS=$'\n'

# Find all directories that have a .git directory in them.
for gitprojpath in $(find . -type d -name .git | sort | sed 's|\/\.git||'); do
    # Save the current working directory before CDing for git's purpose
    pushd . >/dev/null || exit 1

    # Switch to the Git-enabled project directory.
    cd "$gitprojpath" || exit 1

    # Are there any changed files in the status output?
    isdirty=$(git status -s | grep "^.*")
    if [ -n "$isdirty" ]; then
        # Should output be verbose?
        if [ "$1" = "-v" ]; then
            # Output the dirty status.
            echo "DIRTY:" $gitprojpath
            git status -s
            # Or should output be quiet?
        else
            echo "DIRTY:" $gitprojpath
        fi
    fi

    # Return to the starting directory, suppressing the output.
    popd >/dev/null || exit 1
done

# Restore the input field separator.
IFS=$OLDIFS
